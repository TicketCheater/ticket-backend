# JPA 연관 관계를 설정하는 이유

## JPA 연관 관계?
- JPA 를 사용하면 객체 지향적으로 데이터를 다룰 수 있으며, 이는 DB 테이블과 Java 클래스 간의 매핑을 통해 이루어진다.
- 이 때, 서로 다른 엔티티 간의 연관 관계를 설정하는 것이 매우 중요하다.
- 연관 관계 설정은 데이터의 일관성을 유지하고, 보다 효율적인 DB 쿼리를 작성하는 데 도움이 된다.
- JPA 연관 관계는 크게 4가지다. `@OneToOne`, `@ManyToOne`, `@OneToMany`, `@ManyToMany`

## OneToOne 관계
- OneToOne 관계는 두 엔티티가 일대일로 매핑되는 경우에 사용된다.
- 예를 들어, `사용자`와 `주소`가 일대일 관계를 가지면, 사용자는 하나의 주소만 가질 수 있고, 주소는 그 사용자에만 속하는 경우다.

## ManyToOne 관계
- ManyToOne 관계는 여러 엔티티가 하나의 엔티티와 연결될 때 사용된다.
- 예를 들어, 여러 `주문`이 하나의 `사용자`와 연관될 수 있다.

## OneToMany 관계
- OneToMany 관계는 ManyToOne 관계의 반대다.
- 한 엔티티가 여러 엔티티와 연결될 때 사용된다.

## ManyToMany 관계
- ManyToMany 관계는 여러 엔티티가 여러 엔티티와 연결될 때 사용된다.
- 예를 들어, 여러 `학생`이 여러 `수업`에 참여할 수 있다.

## mappedBy?
- `mappedBy` 는 JPA 에서 양방향 연관 관계를 설정할 때 사용되는 속성이다.
- 이는 연관 관계의 주인 엔티티와 피소유자 엔티티를 구분하는 데 사용된다.
- `mappedBy` 속성은 피소유자 쪽에서 사용되며, 주인 쪽의 필드명을 참조한다.
- 예를 들어, `사용자`와 `주문` 간의 ManyToOne 관계에서 `주문`이 관계의 주인이며, `사용자`는 피소유자다.
- 따라서, `사용자` 엔티티에서 `mappedBy` 속성을 사용하여 `주문` 엔티티의 필드명을 지정한다.

## JPA 연관 관계와 N+1 문제
- N+1 문제란, 하나의 쿼리를 통해 조회된 엔티티와 연관된 엔티티들을 추가로 조회하기 위해 N 개의 쿼리가 추가로 실행되는 문제를 말한다.
- 예를 들어, 사용자를 조회한 후 각 사용자에 대한 주문을 조회할 때, 처음 사용자 조회를 위한 1개의 쿼리와 사용자 수만큼의 주문 쿼리(N 개의 쿼리)가 실행된다.

## N+1 문제 해결 방법
- Fetch Join 사용
  - JPQL 에서 `fetch join` 을 사용하면 연관된 엔티티를 한 번의 쿼리로 함께 조회할 수 있다.
- Entity Graph 사용
  - JPA 2.1부터 제공되는 엔티티 그래프를 사용하면 연관된 엔티티를 함께 로딩할 수 있다. 이는 JPQL 을 사용하지 않고도 엔티티 로딩을 최적화할 수 있는 방법이다.
- Batch Fetching 사용
  - Hibernate 에는 배치 페칭 설정을 통해 한 번에 여러 개의 연관된 엔티티를 로딩할 수 있다.
- Lazy Loading 과 FetchType 설정
  - 기본적으로 JPA 에서는 연관된 엔티티를 `Lazy` 로딩으로 설정한다.
  - 필요할 때만 데이터를 로딩하도록 설계하여 불필요한 쿼리를 방지할 수 있다.

